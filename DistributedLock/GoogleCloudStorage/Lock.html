<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: DistributedLock::GoogleCloudStorage::Lock
  
    &mdash; Documentation by YARD 0.9.26
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "DistributedLock::GoogleCloudStorage::Lock";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (L)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../DistributedLock.html" title="DistributedLock (module)">DistributedLock</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../GoogleCloudStorage.html" title="DistributedLock::GoogleCloudStorage (module)">GoogleCloudStorage</a></span></span>
     &raquo; 
    <span class="title">Lock</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: DistributedLock::GoogleCloudStorage::Lock
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">DistributedLock::GoogleCloudStorage::Lock</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  <dl>
      <dt>Includes:</dt>
      <dd><span class='object_link'><a href="Utils.html" title="DistributedLock::GoogleCloudStorage::Utils (module)">Utils</a></span></dd>
  </dl>
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/distributed-lock-google-cloud-storage/lock.rb</dd>
  </dl>
  
</div>


  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="DEFAULT_INSTANCE_IDENTITY_PREFIX_WITHOUT_PID-constant" class="">DEFAULT_INSTANCE_IDENTITY_PREFIX_WITHOUT_PID =
          
        </dt>
        <dd><pre class="code"><span class='const'>SecureRandom</span><span class='period'>.</span><span class='id identifier rubyid_hex'>hex</span><span class='lparen'>(</span><span class='int'>12</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre></dd>
      
    </dl>
  







  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#default_instance_identity_prefix-class_method" title="default_instance_identity_prefix (class method)">.<strong>default_instance_identity_prefix</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Generates a sane default instance identity prefix string.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#abandon-instance_method" title="#abandon (instance method)">#<strong>abandon</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Pretends like we&#39;ve never obtained this lock, abandoning our internal state about the lock.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_health!-instance_method" title="#check_health! (instance method)">#<strong>check_health!</strong>  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Checks whether the lock is healthy.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#healthy%3F-instance_method" title="#healthy? (instance method)">#<strong>healthy?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns whether the lock is healthy.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(bucket_name:, path:, instance_identity_prefix: self.class.default_instance_identity_prefix, thread_safe: true, logger: Logger.new($stderr), logger_mutex: Mutex.new, ttl: DEFAULT_TTL, refresh_interval: nil, max_refresh_fails: DEFAULT_MAX_REFRESH_FAILS, backoff_min: DEFAULT_BACKOFF_MIN, backoff_max: DEFAULT_BACKOFF_MAX, backoff_multiplier: DEFAULT_BACKOFF_MULTIPLIER, object_acl: nil, cloud_storage_options: nil, cloud_storage_bucket_options: nil)  &#x21d2; Lock </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Creates a new Lock instance.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#lock-instance_method" title="#lock (instance method)">#<strong>lock</strong>(timeout: 2 * @ttl)  &#x21d2; void </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Obtains the lock.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#locked_according_to_internal_state%3F-instance_method" title="#locked_according_to_internal_state? (instance method)">#<strong>locked_according_to_internal_state?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns whether this Lock instance&#39;s internal state believes that the lock is currently held by this instance.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#locked_according_to_server%3F-instance_method" title="#locked_according_to_server? (instance method)">#<strong>locked_according_to_server?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns whether the server believes that the lock is currently held by somebody.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#owned_according_to_internal_state%3F-instance_method" title="#owned_according_to_internal_state? (instance method)">#<strong>owned_according_to_internal_state?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns whether this Lock instance&#39;s internal state believes that the lock is held by the current Lock instance in the calling thread.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#owned_according_to_server%3F-instance_method" title="#owned_according_to_server? (instance method)">#<strong>owned_according_to_server?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns whether the server believes that the lock is held by the current Lock instance in the calling thread.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#synchronize-instance_method" title="#synchronize (instance method)">#<strong>synchronize</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Obtains the lock, runs the block, and releases the lock when the block completes.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unlock-instance_method" title="#unlock (instance method)">#<strong>unlock</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Releases the lock and stops refreshing the lock in the background.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(bucket_name:, path:, instance_identity_prefix: self.class.default_instance_identity_prefix, thread_safe: true, logger: Logger.new($stderr), logger_mutex: Mutex.new, ttl: DEFAULT_TTL, refresh_interval: nil, max_refresh_fails: DEFAULT_MAX_REFRESH_FAILS, backoff_min: DEFAULT_BACKOFF_MIN, backoff_max: DEFAULT_BACKOFF_MAX, backoff_multiplier: DEFAULT_BACKOFF_MULTIPLIER, object_acl: nil, cloud_storage_options: nil, cloud_storage_bucket_options: nil)  &#x21d2; <tt><span class='object_link'><a href="" title="DistributedLock::GoogleCloudStorage::Lock (class)">Lock</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'><p>The logger must either be thread-safe, or all writes to this logger by anything besides
this <code>Lock</code> instance must be synchronized through <code>logger_mutex</code>. This is because the logger will be
written to by a background thread.</p>
</div>
  </div>

<p>Creates a new Lock instance.</p>

<p>Under the hood we&#39;ll instantiate a
<a href="https://googleapis.dev/ruby/google-cloud-storage/latest/Google/Cloud/Storage/Bucket.html">Google::Cloud::Storage::Bucket</a>
object for accessing the bucket. You can customize the project ID, authentication method, etc. through
<code>cloud_storage_options</code> and <code>cloud_storage_bucket_options</code>.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>bucket_name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The name of a Cloud Storage bucket in which to place the lock.
This bucket must already exist.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>path</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The object path within the bucket to use for locking.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>instance_identity_prefix</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>self.class.default_instance_identity_prefix</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>A unique identifier for the client of this lock, excluding its thread
identity. Learn more in the readme, section &quot;Instant recovery from stale locks&quot;.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>thread_safe</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Whether this Lock instance should be thread-safe. When true, the thread&#39;s
identity will be included in the instance identity.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>logger</span>
      
      
        <span class='type'></span>
      
      
        <em class="default">(defaults to: <tt>Logger.new($stderr)</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>A Logger-compatible object to log progress to. See also the note about thread-safety.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>logger_mutex</span>
      
      
        <span class='type'></span>
      
      
        <em class="default">(defaults to: <tt>Mutex.new</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>A Mutex to synchronize multithreaded writes to the logger.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>ttl</span>
      
      
        <span class='type'>(<tt>Numeric</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>DEFAULT_TTL</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The lock is considered stale if it&#39;s age (in seconds) is older than this value.
This value should be generous, in the order of minutes.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>refresh_interval</span>
      
      
        <span class='type'>(<tt>Numeric</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>We&#39;ll refresh the lock&#39;s timestamp every <code>refresh_interval</code> seconds. This value should be many
times smaller than <code>ttl</code>, in order to account for network delays, temporary network errors,
and events that cause the lock to become unhealthy.</p>

<p>This value must be smaller than <code>ttl / max_refresh_fails</code>.</p>

<p>Default: <code>ttl / (max_refresh_fails * 3)</code></p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>max_refresh_fails</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>DEFAULT_MAX_REFRESH_FAILS</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The lock will be declared unhealthy if refreshing fails with a temporary error this many times consecutively.
If refreshing fails with a permanent error, then the lock is immediately declared unhealthy regardless of this value.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>backoff_min</span>
      
      
        <span class='type'>(<tt>Numeric</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>DEFAULT_BACKOFF_MIN</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Minimum amount of time, in seconds, to back off when
waiting for a lock to become available. Must be at least 0.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>backoff_max</span>
      
      
        <span class='type'>(<tt>Numeric</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>DEFAULT_BACKOFF_MAX</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Maximum amount of time, in seconds, to back off when
waiting for a lock to become available. Must be at least <code>backoff_min</code>.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>backoff_multiplier</span>
      
      
        <span class='type'>(<tt>Numeric</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>DEFAULT_BACKOFF_MULTIPLIER</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Factor to increase the backoff time by, each time
when acquiring the lock fails. Must be at least 0.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>object_acl</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>A predefined set of access control to apply to the Cloud Storage
object. See the <code>acl</code> parameter in
<a href="Google::Cloud::Storage::Bucket#create_file">https://googleapis.dev/ruby/google-cloud-storage/latest/Google/Cloud/Storage/Bucket.html#create_file-instance_method</a>
for acceptable values.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>cloud_storage_options</span>
      
      
        <span class='type'>(<tt>Hash</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Additional options to pass to
<a href="https://googleapis.dev/ruby/google-cloud-storage/latest/Google/Cloud/Storage.html#new-class_method" target="_parent" title="Google::Cloud::Storage.new">Google::Cloud::Storage.new</a>.
See its documentation to learn which options are available.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>cloud_storage_bucket_options</span>
      
      
        <span class='type'>(<tt>Hash</tt>, <tt>nil</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Additional options to pass to
<a href="https://googleapis.dev/ruby/google-cloud-storage/latest/Google/Cloud/Storage/Project.html#bucket-instance_method" target="_parent" title="Google::Cloud::Storage::Project#bucket">Google::Cloud::Storage::Project#bucket</a>.
See its documentation to learn which options are available.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ArgumentError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>When an invalid argument is detected.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/distributed-lock-google-cloud-storage/lock.rb', line 81</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket_name:</span><span class='comma'>,</span> <span class='label'>path:</span><span class='comma'>,</span> <span class='label'>instance_identity_prefix:</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_default_instance_identity_prefix'>default_instance_identity_prefix</span><span class='comma'>,</span>
  <span class='label'>thread_safe:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>logger:</span> <span class='const'>Logger</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='gvar'>$stderr</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>logger_mutex:</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span>
  <span class='label'>ttl:</span> <span class='const'><span class='object_link'><a href="../GoogleCloudStorage.html#DEFAULT_TTL-constant" title="DistributedLock::GoogleCloudStorage::DEFAULT_TTL (constant)">DEFAULT_TTL</a></span></span><span class='comma'>,</span> <span class='label'>refresh_interval:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>max_refresh_fails:</span> <span class='const'><span class='object_link'><a href="../GoogleCloudStorage.html#DEFAULT_MAX_REFRESH_FAILS-constant" title="DistributedLock::GoogleCloudStorage::DEFAULT_MAX_REFRESH_FAILS (constant)">DEFAULT_MAX_REFRESH_FAILS</a></span></span><span class='comma'>,</span>
  <span class='label'>backoff_min:</span> <span class='const'><span class='object_link'><a href="../GoogleCloudStorage.html#DEFAULT_BACKOFF_MIN-constant" title="DistributedLock::GoogleCloudStorage::DEFAULT_BACKOFF_MIN (constant)">DEFAULT_BACKOFF_MIN</a></span></span><span class='comma'>,</span> <span class='label'>backoff_max:</span> <span class='const'><span class='object_link'><a href="../GoogleCloudStorage.html#DEFAULT_BACKOFF_MAX-constant" title="DistributedLock::GoogleCloudStorage::DEFAULT_BACKOFF_MAX (constant)">DEFAULT_BACKOFF_MAX</a></span></span><span class='comma'>,</span>
  <span class='label'>backoff_multiplier:</span> <span class='const'><span class='object_link'><a href="../GoogleCloudStorage.html#DEFAULT_BACKOFF_MULTIPLIER-constant" title="DistributedLock::GoogleCloudStorage::DEFAULT_BACKOFF_MULTIPLIER (constant)">DEFAULT_BACKOFF_MULTIPLIER</a></span></span><span class='comma'>,</span>
  <span class='label'>object_acl:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>cloud_storage_options:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>cloud_storage_bucket_options:</span> <span class='kw'>nil</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_check_refresh_interval_allowed!'>check_refresh_interval_allowed!</span><span class='lparen'>(</span><span class='id identifier rubyid_ttl'>ttl</span><span class='comma'>,</span> <span class='id identifier rubyid_refresh_interval'>refresh_interval</span><span class='comma'>,</span> <span class='id identifier rubyid_max_refresh_fails'>max_refresh_fails</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_check_backoff_min!'>check_backoff_min!</span><span class='lparen'>(</span><span class='id identifier rubyid_backoff_min'>backoff_min</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_check_backoff_max!'>check_backoff_max!</span><span class='lparen'>(</span><span class='id identifier rubyid_backoff_max'>backoff_max</span><span class='comma'>,</span> <span class='id identifier rubyid_backoff_min'>backoff_min</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_check_backoff_multiplier!'>check_backoff_multiplier!</span><span class='lparen'>(</span><span class='id identifier rubyid_backoff_multiplier'>backoff_multiplier</span><span class='rparen'>)</span>


  <span class='comment'>### Read-only variables (safe to access concurrently) ###
</span>
  <span class='ivar'>@bucket_name</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket_name'>bucket_name</span>
  <span class='ivar'>@path</span> <span class='op'>=</span> <span class='id identifier rubyid_path'>path</span>
  <span class='ivar'>@instance_identity_prefix</span> <span class='op'>=</span> <span class='id identifier rubyid_instance_identity_prefix'>instance_identity_prefix</span>
  <span class='ivar'>@thread_safe</span> <span class='op'>=</span> <span class='id identifier rubyid_thread_safe'>thread_safe</span>
  <span class='ivar'>@logger</span> <span class='op'>=</span> <span class='id identifier rubyid_logger'>logger</span>
  <span class='ivar'>@logger_mutex</span> <span class='op'>=</span> <span class='id identifier rubyid_logger_mutex'>logger_mutex</span>
  <span class='ivar'>@ttl</span> <span class='op'>=</span> <span class='id identifier rubyid_ttl'>ttl</span>
  <span class='ivar'>@refresh_interval</span> <span class='op'>=</span> <span class='id identifier rubyid_refresh_interval'>refresh_interval</span> <span class='op'>||</span> <span class='id identifier rubyid_ttl'>ttl</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>/</span> <span class='lparen'>(</span><span class='id identifier rubyid_max_refresh_fails'>max_refresh_fails</span> <span class='op'>*</span> <span class='int'>3</span><span class='rparen'>)</span>
  <span class='ivar'>@max_refresh_fails</span> <span class='op'>=</span> <span class='id identifier rubyid_max_refresh_fails'>max_refresh_fails</span>
  <span class='ivar'>@backoff_min</span> <span class='op'>=</span> <span class='id identifier rubyid_backoff_min'>backoff_min</span>
  <span class='ivar'>@backoff_max</span> <span class='op'>=</span> <span class='id identifier rubyid_backoff_max'>backoff_max</span>
  <span class='ivar'>@backoff_multiplier</span> <span class='op'>=</span> <span class='id identifier rubyid_backoff_multiplier'>backoff_multiplier</span>
  <span class='ivar'>@object_acl</span> <span class='op'>=</span> <span class='id identifier rubyid_object_acl'>object_acl</span>

  <span class='ivar'>@client</span> <span class='op'>=</span> <span class='id identifier rubyid_create_gcloud_storage_client'>create_gcloud_storage_client</span><span class='lparen'>(</span><span class='id identifier rubyid_cloud_storage_options'>cloud_storage_options</span><span class='rparen'>)</span>
  <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_get_gcloud_storage_bucket'>get_gcloud_storage_bucket</span><span class='lparen'>(</span><span class='ivar'>@client</span><span class='comma'>,</span> <span class='id identifier rubyid_bucket_name'>bucket_name</span><span class='comma'>,</span> <span class='id identifier rubyid_cloud_storage_bucket_options'>cloud_storage_bucket_options</span><span class='rparen'>)</span>

  <span class='ivar'>@state_mutex</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@refresher_cond</span> <span class='op'>=</span> <span class='const'>ConditionVariable</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>


  <span class='comment'>### Read-write variables protected by @state_mutex ###
</span>
  <span class='ivar'>@owner</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@metageneration</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@refresher_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='comment'># The refresher generation is incremented every time we shutdown
</span>  <span class='comment'># the refresher thread. It allows the refresher thread to know
</span>  <span class='comment'># whether it&#39;s being shut down (and thus shouldn&#39;t access/modify
</span>  <span class='comment'># state).
</span>  <span class='ivar'>@refresher_generation</span> <span class='op'>=</span> <span class='int'>0</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="default_instance_identity_prefix-class_method">
  
    .<strong>default_instance_identity_prefix</strong>  &#x21d2; <tt>String</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Generates a sane default instance identity prefix string. The result is identical across multiple calls
in the same process. It supports forking, so that calling this method in a forked child process
automatically returns a different value than when called from the parent process.</p>

<p>The result doesn&#39;t include a thread identitier, which is why we call this a prefix.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


26
27
28</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/distributed-lock-google-cloud-storage/lock.rb', line 26</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_default_instance_identity_prefix'>default_instance_identity_prefix</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="#DEFAULT_INSTANCE_IDENTITY_PREFIX_WITHOUT_PID-constant" title="DistributedLock::GoogleCloudStorage::Lock::DEFAULT_INSTANCE_IDENTITY_PREFIX_WITHOUT_PID (constant)">DEFAULT_INSTANCE_IDENTITY_PREFIX_WITHOUT_PID</a></span></span><span class='embexpr_end'>}</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_pid'>pid</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="abandon-instance_method">
  
    #<strong>abandon</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Pretends like we&#39;ve never obtained this lock, abandoning our internal state about the lock.</p>

<p>Shuts down background lock refreshing, and ensures that</p>

<h1 id="locked_according_to_internal_state-returns-false">locked_according_to_internal_state? returns false.</h1>

<p>Does not modify any server data, so #locked_according_to_server? may still return true.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/distributed-lock-google-cloud-storage/lock.rb', line 282</span>

<span class='kw'>def</span> <span class='id identifier rubyid_abandon'>abandon</span>
  <span class='id identifier rubyid_refresher_generation'>refresher_generation</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_thread'>thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='ivar'>@state_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_unsynced_locked_according_to_internal_state?'>unsynced_locked_according_to_internal_state?</span>
      <span class='id identifier rubyid_refresher_generation'>refresher_generation</span> <span class='op'>=</span> <span class='ivar'>@refresher_generation</span>
      <span class='id identifier rubyid_thread'>thread</span> <span class='op'>=</span> <span class='id identifier rubyid_shutdown_refresher_thread'>shutdown_refresher_thread</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_thread'>thread</span>
    <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Abandoning locked lock</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_thread'>thread</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span>
    <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Done abandoned locked lock. refresher_generation=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_refresher_generation'>refresher_generation</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Abandoning unlocked lock</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="check_health!-instance_method">
  
    #<strong>check_health!</strong>  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Checks whether the lock is healthy. See #healthy? for the definition of &quot;healthy&quot;.</p>

<p>It only makes sense to call this method after having obtained this lock.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="LockUnhealthyError.html" title="DistributedLock::GoogleCloudStorage::LockUnhealthyError (class)">LockUnhealthyError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>When an unhealthy state is detected.</p>
</div>
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="NotLockedError.html" title="DistributedLock::GoogleCloudStorage::NotLockedError (class)">NotLockedError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>This lock was not obtained.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


328
329
330</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/distributed-lock-google-cloud-storage/lock.rb', line 328</span>

<span class='kw'>def</span> <span class='id identifier rubyid_check_health!'>check_health!</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="LockUnhealthyError.html" title="DistributedLock::GoogleCloudStorage::LockUnhealthyError (class)">LockUnhealthyError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Lock is not healthy</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_healthy?'>healthy?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="healthy?-instance_method">
  
    #<strong>healthy?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns whether the lock is healthy. A lock is considered healthy until
we fail to refresh the lock too many times consecutively.</p>

<p>Failure to refresh could happen for many reasons, including but not limited
to: network problems, the lock object being forcefully deleted by someone else.</p>

<p>&quot;Too many&quot; is defined by the <code>max_refresh_fails</code> argument passed to the constructor.</p>

<p>It only makes sense to call this method after having obtained this lock.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="NotLockedError.html" title="DistributedLock::GoogleCloudStorage::NotLockedError (class)">NotLockedError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>This lock was not obtained.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


314
315
316
317
318
319</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/distributed-lock-google-cloud-storage/lock.rb', line 314</span>

<span class='kw'>def</span> <span class='id identifier rubyid_healthy?'>healthy?</span>
  <span class='ivar'>@state_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="NotLockedError.html" title="DistributedLock::GoogleCloudStorage::NotLockedError (class)">NotLockedError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Not locked</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_unsynced_locked_according_to_internal_state?'>unsynced_locked_according_to_internal_state?</span>
    <span class='ivar'>@refresher_thread</span><span class='period'>.</span><span class='id identifier rubyid_alive?'>alive?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="lock-instance_method">
  
    #<strong>lock</strong>(timeout: 2 * @ttl)  &#x21d2; <tt>void</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p><p>Obtains the lock. If the lock is stale, resets it automatically. If the lock is already
obtained by some other instance identity, waits until it becomes available,
or until timeout.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>timeout</span>
      
      
        <span class='type'>(<tt>Numeric</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>2 * @ttl</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The timeout in seconds.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="AlreadyLockedError.html" title="DistributedLock::GoogleCloudStorage::AlreadyLockedError (class)">AlreadyLockedError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>This Lock instance — according to its internal state — believes
that it&#39;s already holding the lock.</p>
</div>
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="TimeoutError.html" title="DistributedLock::GoogleCloudStorage::TimeoutError (class)">TimeoutError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Failed to acquire the lock within <code>timeout</code> seconds.</p>
</div>
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt>Google::Cloud::Error</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/distributed-lock-google-cloud-storage/lock.rb', line 180</span>

<span class='kw'>def</span> <span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='label'>timeout:</span> <span class='int'>2</span> <span class='op'>*</span> <span class='ivar'>@ttl</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="AlreadyLockedError.html" title="DistributedLock::GoogleCloudStorage::AlreadyLockedError (class)">AlreadyLockedError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Already locked</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_owned_according_to_internal_state?'>owned_according_to_internal_state?</span>

  <span class='id identifier rubyid_file'>file</span> <span class='op'>=</span> <span class='id identifier rubyid_retry_with_backoff_until_success'>retry_with_backoff_until_success</span><span class='lparen'>(</span><span class='id identifier rubyid_timeout'>timeout</span><span class='comma'>,</span>
    <span class='label'>retry_logger:</span> <span class='id identifier rubyid_method'>method</span><span class='lparen'>(</span><span class='symbol'>:log_lock_retry</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>backoff_min:</span> <span class='ivar'>@backoff_min</span><span class='comma'>,</span>
    <span class='label'>backoff_max:</span> <span class='ivar'>@backoff_max</span><span class='comma'>,</span>
    <span class='label'>backoff_multiplier:</span> <span class='ivar'>@backoff_multiplier</span><span class='rparen'>)</span> <span class='kw'>do</span>

    <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Acquiring lock</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span> <span class='op'>=</span> <span class='id identifier rubyid_create_lock_object'>create_lock_object</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Successfully acquired lock</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
      <span class='lbracket'>[</span><span class='symbol'>:success</span><span class='comma'>,</span> <span class='id identifier rubyid_file'>file</span><span class='rbracket'>]</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Error acquiring lock. Investigating why...</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_file'>file</span> <span class='op'>=</span> <span class='ivar'>@bucket</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span><span class='lparen'>(</span><span class='ivar'>@path</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_log_warn'>log_warn</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Lock was deleted right after having created it. Retrying.</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
        <span class='symbol'>:retry_immediately</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_metadata'>metadata</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>identity</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='id identifier rubyid_identity'>identity</span>
        <span class='id identifier rubyid_log_warn'>log_warn</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Lock was already owned by this instance, but was abandoned. Resetting lock</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
        <span class='id identifier rubyid_delete_lock_object'>delete_lock_object</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_metageneration'>metageneration</span><span class='rparen'>)</span>
        <span class='symbol'>:retry_immediately</span>
      <span class='kw'>else</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_lock_stale?'>lock_stale?</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_log_warn'>log_warn</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Lock is stale. Resetting lock</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
          <span class='id identifier rubyid_delete_lock_object'>delete_lock_object</span><span class='lparen'>(</span><span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_metageneration'>metageneration</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Lock was already acquired, and is not stale</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span>
        <span class='kw'>end</span>
        <span class='symbol'>:error</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_refresher_generation'>refresher_generation</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@state_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@owner</span> <span class='op'>=</span> <span class='id identifier rubyid_identity'>identity</span>
    <span class='ivar'>@metageneration</span> <span class='op'>=</span> <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_metageneration'>metageneration</span>
    <span class='id identifier rubyid_spawn_refresher_thread'>spawn_refresher_thread</span>
    <span class='id identifier rubyid_refresher_generation'>refresher_generation</span> <span class='op'>=</span> <span class='ivar'>@refresher_generation</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Locked. refresher_generation=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_refresher_generation'>refresher_generation</span><span class='embexpr_end'>}</span><span class='tstring_content'>, metageneration=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_metageneration'>metageneration</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="locked_according_to_internal_state?-instance_method">
  
    #<strong>locked_according_to_internal_state?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns whether this Lock instance&#39;s internal state believes that the lock
is currently held by this instance. Does not check whether the lock is stale.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


134
135
136
137
138</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/distributed-lock-google-cloud-storage/lock.rb', line 134</span>

<span class='kw'>def</span> <span class='id identifier rubyid_locked_according_to_internal_state?'>locked_according_to_internal_state?</span>
  <span class='ivar'>@state_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_unsynced_locked_according_to_internal_state?'>unsynced_locked_according_to_internal_state?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="locked_according_to_server?-instance_method">
  
    #<strong>locked_according_to_server?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns whether the server believes that the lock is currently held by somebody.
Does not check whether the lock is stale.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>Google::Cloud::Error</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


145
146
147</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/distributed-lock-google-cloud-storage/lock.rb', line 145</span>

<span class='kw'>def</span> <span class='id identifier rubyid_locked_according_to_server?'>locked_according_to_server?</span>
  <span class='op'>!</span><span class='ivar'>@bucket</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span><span class='lparen'>(</span><span class='ivar'>@path</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="owned_according_to_internal_state?-instance_method">
  
    #<strong>owned_according_to_internal_state?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns whether this Lock instance&#39;s internal state believes that the lock
is held by the current Lock instance in the calling thread.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


153
154
155
156
157</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/distributed-lock-google-cloud-storage/lock.rb', line 153</span>

<span class='kw'>def</span> <span class='id identifier rubyid_owned_according_to_internal_state?'>owned_according_to_internal_state?</span>
  <span class='ivar'>@state_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_unsynced_owned_according_to_internal_state?'>unsynced_owned_according_to_internal_state?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="owned_according_to_server?-instance_method">
  
    #<strong>owned_according_to_server?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns whether the server believes that the lock is held by the current
Lock instance in the calling thread.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>Google::Cloud::Error</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


164
165
166
167
168</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/distributed-lock-google-cloud-storage/lock.rb', line 164</span>

<span class='kw'>def</span> <span class='id identifier rubyid_owned_according_to_server?'>owned_according_to_server?</span>
  <span class='id identifier rubyid_file'>file</span> <span class='op'>=</span> <span class='ivar'>@bucket</span><span class='period'>.</span><span class='id identifier rubyid_file'>file</span><span class='lparen'>(</span><span class='ivar'>@path</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_metadata'>metadata</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>identity</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='id identifier rubyid_identity'>identity</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="synchronize-instance_method">
  
    #<strong>synchronize</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Obtains the lock, runs the block, and releases the lock when the block completes.</p>

<p>If the lock is stale, resets it automatically. If the lock is already
obtained by some other instance identity, waits until it becomes available,
or until timeout.</p>

<p>Accepts the same parameters as #lock.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'></span>
      
      
      
        
        <div class='inline'><p>The block&#39;s return value.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="AlreadyLockedError.html" title="DistributedLock::GoogleCloudStorage::AlreadyLockedError (class)">AlreadyLockedError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>This Lock instance — according to its internal state — believes
that it&#39;s already holding the lock.</p>
</div>
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="TimeoutError.html" title="DistributedLock::GoogleCloudStorage::TimeoutError (class)">TimeoutError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Failed to acquire the lock within <code>timeout</code> seconds.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


265
266
267
268
269
270
271
272</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/distributed-lock-google-cloud-storage/lock.rb', line 265</span>

<span class='kw'>def</span> <span class='id identifier rubyid_synchronize'>synchronize</span><span class='lparen'>(</span><span class='op'>...</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_lock'>lock</span><span class='lparen'>(</span><span class='op'>...</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='kw'>yield</span>
  <span class='kw'>ensure</span>
    <span class='id identifier rubyid_unlock'>unlock</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unlock-instance_method">
  
    #<strong>unlock</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Releases the lock and stops refreshing the lock in the background.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>True if the lock object was actually deleted, false if the lock object
was already deleted.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="NotLockedError.html" title="DistributedLock::GoogleCloudStorage::NotLockedError (class)">NotLockedError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>This Lock instance — according to its internal state — believes
that it isn&#39;t currently holding the lock.</p>
</div>
      
    </li>
  
    <li>
      
      
        <span class='type'>(<tt>Google::Cloud::Error</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/distributed-lock-google-cloud-storage/lock.rb', line 233</span>

<span class='kw'>def</span> <span class='id identifier rubyid_unlock'>unlock</span>
  <span class='id identifier rubyid_refresher_generation'>refresher_generation</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_metageneration'>metageneration</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_thread'>thread</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='ivar'>@state_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="NotLockedError.html" title="DistributedLock::GoogleCloudStorage::NotLockedError (class)">NotLockedError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Not locked</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_unsynced_locked_according_to_internal_state?'>unsynced_locked_according_to_internal_state?</span>
    <span class='id identifier rubyid_refresher_generation'>refresher_generation</span> <span class='op'>=</span> <span class='ivar'>@refresher_generation</span>
    <span class='id identifier rubyid_thread'>thread</span> <span class='op'>=</span> <span class='id identifier rubyid_shutdown_refresher_thread'>shutdown_refresher_thread</span>
    <span class='id identifier rubyid_metageneration'>metageneration</span> <span class='op'>=</span> <span class='ivar'>@metageneration</span>
    <span class='ivar'>@owner</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@metageneration</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_thread'>thread</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span>
  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='id identifier rubyid_delete_lock_object'>delete_lock_object</span><span class='lparen'>(</span><span class='id identifier rubyid_metageneration'>metageneration</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unlocked. refresher_generation=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_refresher_generation'>refresher_generation</span><span class='embexpr_end'>}</span><span class='tstring_content'>, metageneration=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_metageneration'>metageneration</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Thu Sep  9 19:12:16 2021 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.26 (ruby-2.7.4).
</div>

    </div>
  </body>
</html>